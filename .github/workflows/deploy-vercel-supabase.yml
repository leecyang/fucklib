# Deploy to Vercel + Supabase Workflow
# ‰ªÖÂú® deploy/vercel-supabase ÂàÜÊîØ‰∏äËß¶Âèë
# Áõ¥Êé•ÈÉ®ÁΩ≤Âà∞Áîü‰∫ßÁéØÂ¢ÉÔºåÈÅøÂÖç‰∏é main/release ÂàÜÊîØÂêåÊ≠•

name: Deploy to Vercel & Supabase

on:
  push:
    branches:
      - deploy/vercel-supabase
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

# Á°Æ‰øù‰∏ç‰ºö‰∏éÂÖ∂‰ªñÂàÜÊîØÁöÑÈÉ®ÁΩ≤ÂÜ≤Á™Å
concurrency:
  group: deploy-vercel-supabase
  cancel-in-progress: true

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ==========================================
  # ÈÉ®ÁΩ≤ Supabase Êï∞ÊçÆÂ∫ìËøÅÁßª
  # ==========================================
  deploy-supabase:
    name: üóÑÔ∏è Deploy Supabase Migrations
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          ref: deploy/vercel-supabase

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install Supabase CLI
        run: npm install -g supabase

      - name: üîó Link Supabase Project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: üöÄ Push Database Migrations
        run: |
          supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: üìä Validate Database Schema
        run: |
          echo "‚úÖ Supabase migrations deployed successfully"
        continue-on-error: true

  # ==========================================
  # ÈÉ®ÁΩ≤ Vercel (Frontend + Backend API)
  # ==========================================
  deploy-vercel:
    name: üöÄ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: deploy-supabase  # Á≠âÂæÖ Supabase ÈÉ®ÁΩ≤ÂÆåÊàê
    if: ${{ !failure() }}   # Âç≥‰Ωø Supabase Â§±Ë¥•‰πüÁªßÁª≠ÔºàÂèØÈÄâÔºâ
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          ref: deploy/vercel-supabase

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install Vercel CLI
        run: npm install -g vercel@latest

      - name: üì¶ Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: üî® Build Frontend
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install Backend Dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üîó Pull Vercel Environment Info
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: üî® Build Vercel Project
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: üöÄ Deploy to Vercel Production
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployed to: $DEPLOYMENT_URL"

      - name: üìù Post Deployment Summary
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ‚úÖ | \`deploy/vercel-supabase\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Vercel | ‚úÖ | ${{ steps.deploy.outputs.deployment_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase | ‚úÖ | Migrations Applied |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üïê Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # ÈÉ®ÁΩ≤ÂêéÂÅ•Â∫∑Ê£ÄÊü•
  # ==========================================
  health-check:
    name: üè• Health Check
    runs-on: ubuntu-latest
    needs: deploy-vercel
    
    steps:
      - name: ‚è≥ Wait for deployment to stabilize
        run: sleep 30

      - name: üîç Check API Health
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_URL }}/api/health || echo "000")
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "404" ]; then
            echo "‚úÖ API is responding (Status: $RESPONSE)"
          else
            echo "‚ö†Ô∏è API health check returned unexpected status: $RESPONSE"
          fi

      - name: üîç Check Frontend
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_URL }} || echo "000")
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Frontend is live"
          else
            echo "‚ö†Ô∏è Frontend returned status: $RESPONSE"
          fi
