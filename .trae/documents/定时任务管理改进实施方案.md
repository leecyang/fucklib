## 后端改动
- 模型与数据库
  - 在`e:\project\fucklib\backend\app\models.py:56-73`的`Task`模型新增`remark`列：`String(500)`，用于用户备注，独立于`last_message`。
  - 提供一次性迁移：SQLite 执行`ALTER TABLE tasks ADD COLUMN remark VARCHAR(500)`；在`e:\project\fucklib\backend\main.py`的`init_db()`中检测列缺失时自动补列，避免影响现有数据。
- 调度器与默认行为
  - 在`e:\project\fucklib\backend\app\scheduler.py:157-185`的`add_task_job`中，为`CronTrigger.from_crontab(...)`设置`start_date`为当前时间（`Asia/Shanghai`），确保新任务从当日开始计算下一次执行。
  - 保持现有逻辑：若设定时间已过，则下一次运行为次日；若未过，当日运行。
- API 与事务
  - 更新`TaskResponse`以返回`next_run`字段（下次执行时间），便于前端排序。
  - 在`e:\project\fucklib\backend\app\routers\tasks.py:30-48`的`update_task`中添加事务处理：
    - 使用`with db.begin():`或`try/except`+`rollback`确保`is_enabled`切换的原子性。
    - 先提交数据库，再更新调度器；若调度器更新失败，回滚状态并返回错误响应。
  - 新增`PATCH /tasks/{id}/toggle`接口，仅切换`is_enabled`，避免误改其他字段；沿用上述事务与调度一致性策略。
  - `GET /tasks/`计算并返回每个任务的`next_run`（基于`CronTrigger`与当前时间）。
- 校验
  - 在`e:\project\fucklib\backend\app\schemas.py:42-64`为`TaskCreate/TaskUpdate`添加：
    - `remark: Optional[str] = Field(None, max_length=500)`。
    - `cron_expression`格式校验（5 段、分钟/小时为合法数值）。
    - 针对`task_type`与`config`的条件校验：`reserve`下`strategy`为`default_all|custom`；`custom`时必须提供`lib_id`与`seat_key`。

## 前端改动
- 列表与表头
  - 在`e:\project\fucklib\frontend\src\pages\ScheduledTasks.tsx:122-129`，将表头“时间（Cron）”改为“时间”。
  - 使用后端返回的`next_run`进行排序（升序）。如后端暂不可用，前端根据`cron_expression`与当前时间本地计算下一次执行时间再排序。
- 启用/禁用开关
  - 为`ToggleSwitch`增加点击处理：调用`taskApi.updateTask(id, { is_enabled: !task.is_enabled })`或`PATCH /tasks/{id}/toggle`，成功后刷新或乐观更新`tasks`。
  - 明确展示当前状态：开为高亮，关为灰显；在移动端与桌面端均统一。
- 备注字段
  - 在任务行与卡片视图中新增“备注”展示，来源`task.remark`。
  - 在新建任务弹窗与编辑交互中支持添加/修改备注；调用`taskApi.updateTask`或新建时传入`remark`。
  - 客户端校验备注长度≤500，禁止仅空白内容。
- 客户端校验
  - 创建任务：校验`time`必填；当`type==='reserve' && strategy==='custom'`时必须选择座位。
  - 禁止非法`time`格式；`cron_expression`由`HH:mm`可靠转换为`m h * * *`。

## 排序与“闹钟式”逻辑
- 严格按实际下一次执行时间排序：
  - 依据`next_run`（同一时区`Asia/Shanghai`）。
  - 当天未到的时间优先；已过的时间次日的`next_run`参与排序。

## 事务性保证
- 所有状态变更（启用/禁用）在单个事务中完成；任何错误导致回滚。
- 调度器更新与数据库状态保持一致：失败时恢复原值并返回错误，避免“界面开关开了但实际未生效”。

## API 变更摘要
- `GET /tasks/`：响应增加`next_run`与`remark`。
- `POST /tasks/`：请求支持`remark`。
- `PUT /tasks/{id}`：可更新`remark`与`is_enabled`等；含事务与调度更新。
- `PATCH /tasks/{id}/toggle`：仅切换启用状态（可选）。

## 验证与测试
- 后端：
  - 单元测试覆盖`cron_expression`校验、`next_run`计算、启用/禁用事务与调度一致性。
- 前端：
  - 交互测试：开关切换、备注增改、排序正确性（含边界：当前时间前/后）。
- 手动回归：创建不同时间的任务，确认当天未过的时间会当日执行；表头显示为“时间”；列表按`next_run`排序；备注持久化。

## 实施顺序
1) 后端 Schema/模型与迁移
2) 调度器`start_date`与`next_run`
3) 事务与`toggle`接口
4) 前端显示、排序、开关交互与备注
5) 测试与回归
